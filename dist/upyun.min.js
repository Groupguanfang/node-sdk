/**
  * UPYUN js-sdk 3.2.4
  * (c) 2017
  * @license MIT
  */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r(require("axios")):"function"==typeof define&&define.amd?define(["axios"],r):e.upyun=r(e.axios)}(this,function(e){"use strict";function r(e,r,t){return new Promise(function(n,o){var i=e.slice||e.mozSlice||e.webkitSlice;return i?n(i.call(e,r,t)):o(new Error("not support File type!"))})}function t(r,t,n){var o=n.authorization,i=n.policy,u=new FormData;return u.append("authorization",o),u.append("policy",i),u.append("file",t),e.post(r,u).then(function(e){var r=e.status,t=e.data;return 200===r&&Promise.resolve(t)})}function n(e,r,t,n){function o(e,r,t,n){return e<20?r&t|~r&n:e<40?r^t^n:e<60?r&t|r&n|t&n:r^t^n}function i(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function u(e,r){var t=(65535&e)+(65535&r);return(e>>16)+(r>>16)+(t>>16)<<16|65535&t}function a(e,r){return e<<r|e>>>32-r}function s(e,r){e[r>>5]|=128<<24-r%32,e[15+(r+64>>9<<4)]=r;for(var t=[80],n=1732584193,s=-271733879,c=-1732584194,l=271733878,f=-1009589776,h=0;h<e.length;h+=16){for(var d=n,p=s,v=c,y=l,g=f,m=0;m<80;m++){t[m]=m<16?e[h+m]:a(t[m-3]^t[m-8]^t[m-14]^t[m-16],1);var b=u(u(a(n,5),o(m,s,c,l)),u(u(f,t[m]),i(m)));f=l,l=c,c=a(s,30),s=n,n=b}n=u(n,d),s=u(s,p),c=u(c,v),l=u(l,y),f=u(f,g)}return[n,s,c,l,f]}function c(e){for(var r=[],t=(1<<n)-1,o=0;o<e.length*n;o+=n)r[o>>5]|=(e.charCodeAt(o/8)&t)<<32-n-o%32;return r}function l(e,r){var t=c(e);t.length>16&&(t=s(t,e.length*n));for(var o=[16],i=[16],u=0;u<16;u++)o[u]=909522486^t[u],i[u]=1549556828^t[u];var a=s(o.concat(c(r)),512+r.length*n);return s(i.concat(a),672)}function f(e){for(var r="",n=0;n<4*e.length;n+=3)for(var o=(e[n>>2]>>8*(3-n%4)&255)<<16|(e[n+1>>2]>>8*(3-(n+1)%4)&255)<<8|e[n+2>>2]>>8*(3-(n+2)%4)&255,i=0;i<4;i++)8*n+6*i>32*e.length?r+=t:r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(o>>6*(3-i)&63);return r}return t||(t="="),n||(n=8),function(e,r){return f(l(e,r))}(e,r)}function o(e,r){return r={exports:{}},e(r,r.exports),r.exports}function i(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}function u(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&i(e.slice(0,0))}function a(e,r,t){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=(new Date).toGMTString();return{Authorization:s(e,{method:r,path:t="/"+e.serviceName+t,date:o,contentMd5:n}),"X-Date":o}}function s(e,r){var t=r.method,n=r.path,o=[t,encodeURI(n)];["date","policy","contentMd5"].forEach(function(e){r[e]&&o.push(r[e])});var i=v(e.password,o.join("&"));return"UPYUN "+e.operatorName+":"+i}function c(e,r){if(r.service=e.serviceName,void 0===r["save-key"])throw new Error("upyun - calclate body sign need save-key");void 0===r.expiration&&(r.expiration=parseInt(new Date/1e3+1800,10));var t=g.encode(JSON.stringify(r));return{policy:t,authorization:s(e,{method:"POST",path:"/"+e.serviceName,policy:t})}}function l(e,r){var t=(new Date).toGMTString(),n=r.join("\n"),o=A(n+"&"+e.serviceName+"&"+t+"&"+e.password);return{Authorization:"UpYun "+e.serviceName+":"+e.operatorName+":"+o,Date:t,"User-Agent":"Js-Sdk/"+m.version}}function f(e){return 0===e.indexOf("x-upyun-meta-")}function h(e,r,t){var n=S.getHeaderSign(e,r,t);return Promise.resolve(n)}e="default"in e?e.default:e;var d=function(r,t,n){var o=e.create({baseURL:r+"/"+t.serviceName});return o.interceptors.request.use(function(e){var r=e.method.toUpperCase(),o=e.url.substring(e.baseURL.length);return e.url=encodeURI(e.url),n(t,r,o).then(function(r){return e.headers.common=r,Promise.resolve(e)})},function(e){throw new Error("upyun - request failed: "+e.message)}),o.interceptors.response.use(function(e){return e},function(e){var r=e.response;if(void 0===r)throw e;if(404!==r.status)throw new Error("upyun - response error: "+r.data.code+" "+r.data.msg);return r}),o},p={readBlockAsync:r},v=n,y="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},g=o(function(e,r){!function(t){var n=r,o=e&&e.exports==n&&e,i="object"==typeof y&&y;i.global!==i&&i.window!==i||(t=i);var u=function(e){this.message=e};(u.prototype=new Error).name="InvalidCharacterError";var a=function(e){throw new u(e)},s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c=/[\t\n\f\r ]/g,l={encode:function(e){e=String(e),/[^\0-\xFF]/.test(e)&&a("The string to be encoded contains characters outside of the Latin1 range.");for(var r,t=e.length%3,n="",o=-1,i=e.length-t;++o<i;)r=(e.charCodeAt(o)<<16)+(e.charCodeAt(++o)<<8)+e.charCodeAt(++o),n+=s.charAt(r>>18&63)+s.charAt(r>>12&63)+s.charAt(r>>6&63)+s.charAt(63&r);return 2==t?(r=(e.charCodeAt(o)<<8)+e.charCodeAt(++o),n+=s.charAt(r>>10)+s.charAt(r>>4&63)+s.charAt(r<<2&63)+"="):1==t&&(r=e.charCodeAt(o),n+=s.charAt(r>>2)+s.charAt(r<<4&63)+"=="),n},decode:function(e){var r=(e=String(e).replace(c,"")).length;r%4==0&&(r=(e=e.replace(/==?$/,"")).length),(r%4==1||/[^+a-zA-Z0-9/]/.test(e))&&a("Invalid character: the string to be decoded is not correctly encoded.");for(var t,n,o=0,i="",u=-1;++u<r;)n=s.indexOf(e.charAt(u)),t=o%4?64*t+n:n,o++%4&&(i+=String.fromCharCode(255&t>>(-2*o&6)));return i},version:"0.1.0"};if(n&&!n.nodeType)if(o)o.exports=l;else for(var f in l)l.hasOwnProperty(f)&&(n[f]=l[f]);else t.base64=l}(y)}),m={name:"upyun",version:"3.2.3",description:"UPYUN js sdk",main:"dist/upyun.common.js",module:"dist/upyun.esm.js",scripts:{build:"node build/build.js",test:"npm run test:server && npm run test:client","test:client":"karma start tests/karma.conf.js","test:server":"mocha --compilers js:babel-register tests/server/*"},repository:{type:"git",url:"git@github.com:upyun/node-sdk.git"},keywords:["upyun","js","nodejs","sdk","cdn","cloud","storage"],author:"Leigh",license:"MIT",bugs:{url:"https://github.com/upyun/node-sdk/issues"},homepage:"https://github.com/upyun/node-sdk",contributors:[{name:"yejingx",email:"yejingx@gmail.com"},{name:"Leigh",email:"i@zhuli.me"},{name:"kaidiren",email:"kaidiren@gmail.com"},{name:"Gaara",email:"sabakugaara@users.noreply.github.com"}],devDependencies:{"babel-cli":"^6.24.1","babel-loader":"^7.0.0","babel-plugin-external-helpers":"^6.22.0","babel-plugin-transform-runtime":"^6.23.0","babel-preset-env":"^1.4.0","babel-register":"^6.24.1",chai:"^3.5.0",istanbul:"^0.4.3",karma:"^1.7.0","karma-chrome-launcher":"^2.1.1","karma-mocha":"^1.3.0","karma-sourcemap-loader":"^0.3.7","karma-webpack":"^2.0.3",mocha:"^3.4.1",rollup:"^0.41.6","rollup-plugin-alias":"^1.3.1","rollup-plugin-babel":"^2.7.1","rollup-plugin-commonjs":"^8.0.2","rollup-plugin-json":"^2.1.1","rollup-plugin-node-resolve":"^3.0.0",should:"^9.0.2","uglify-js":"^3.0.11",webpack:"^2.5.1"},dependencies:{axios:"^0.16.1","base-64":"^0.1.0","form-data":"^2.1.4",hmacsha1:"^1.0.0",md5:"^2.2.1","mime-types":"^2.1.15"},browser:{"./upyun/utils.js":"./upyun/browser-utils.js","./upyun/form-upload.js":"./upyun/browser-form-upload.js"}},b=o(function(e){!function(){var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t={rotl:function(e,r){return e<<r|e>>>32-r},rotr:function(e,r){return e<<32-r|e>>>r},endian:function(e){if(e.constructor==Number)return 16711935&t.rotl(e,8)|4278255360&t.rotl(e,24);for(var r=0;r<e.length;r++)e[r]=t.endian(e[r]);return e},randomBytes:function(e){for(var r=[];e>0;e--)r.push(Math.floor(256*Math.random()));return r},bytesToWords:function(e){for(var r=[],t=0,n=0;t<e.length;t++,n+=8)r[n>>>5]|=e[t]<<24-n%32;return r},wordsToBytes:function(e){for(var r=[],t=0;t<32*e.length;t+=8)r.push(e[t>>>5]>>>24-t%32&255);return r},bytesToHex:function(e){for(var r=[],t=0;t<e.length;t++)r.push((e[t]>>>4).toString(16)),r.push((15&e[t]).toString(16));return r.join("")},hexToBytes:function(e){for(var r=[],t=0;t<e.length;t+=2)r.push(parseInt(e.substr(t,2),16));return r},bytesToBase64:function(e){for(var t=[],n=0;n<e.length;n+=3)for(var o=e[n]<<16|e[n+1]<<8|e[n+2],i=0;i<4;i++)8*n+6*i<=8*e.length?t.push(r.charAt(o>>>6*(3-i)&63)):t.push("=");return t.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/gi,"");for(var t=[],n=0,o=0;n<e.length;o=++n%4)0!=o&&t.push((r.indexOf(e.charAt(n-1))&Math.pow(2,-2*o+8)-1)<<2*o|r.indexOf(e.charAt(n))>>>6-2*o);return t}};e.exports=t}()}),w={utf8:{stringToBytes:function(e){return w.bin.stringToBytes(unescape(encodeURIComponent(e)))},bytesToString:function(e){return decodeURIComponent(escape(w.bin.bytesToString(e)))}},bin:{stringToBytes:function(e){for(var r=[],t=0;t<e.length;t++)r.push(255&e.charCodeAt(t));return r},bytesToString:function(e){for(var r=[],t=0;t<e.length;t++)r.push(String.fromCharCode(e[t]));return r.join("")}}},k=w,x=function(e){return null!=e&&(i(e)||u(e)||!!e._isBuffer)},A=o(function(e){!function(){var r=b,t=k.utf8,n=x,o=k.bin,i=function(e,u){e.constructor==String?e=u&&"binary"===u.encoding?o.stringToBytes(e):t.stringToBytes(e):n(e)?e=Array.prototype.slice.call(e,0):Array.isArray(e)||(e=e.toString());for(var a=r.bytesToWords(e),s=8*e.length,c=1732584193,l=-271733879,f=-1732584194,h=271733878,d=0;d<a.length;d++)a[d]=16711935&(a[d]<<8|a[d]>>>24)|4278255360&(a[d]<<24|a[d]>>>8);a[s>>>5]|=128<<s%32,a[14+(s+64>>>9<<4)]=s;for(var p=i._ff,v=i._gg,y=i._hh,g=i._ii,d=0;d<a.length;d+=16){var m=c,b=l,w=f,k=h;l=g(l=g(l=g(l=g(l=y(l=y(l=y(l=y(l=v(l=v(l=v(l=v(l=p(l=p(l=p(l=p(l,f=p(f,h=p(h,c=p(c,l,f,h,a[d+0],7,-680876936),l,f,a[d+1],12,-389564586),c,l,a[d+2],17,606105819),h,c,a[d+3],22,-1044525330),f=p(f,h=p(h,c=p(c,l,f,h,a[d+4],7,-176418897),l,f,a[d+5],12,1200080426),c,l,a[d+6],17,-1473231341),h,c,a[d+7],22,-45705983),f=p(f,h=p(h,c=p(c,l,f,h,a[d+8],7,1770035416),l,f,a[d+9],12,-1958414417),c,l,a[d+10],17,-42063),h,c,a[d+11],22,-1990404162),f=p(f,h=p(h,c=p(c,l,f,h,a[d+12],7,1804603682),l,f,a[d+13],12,-40341101),c,l,a[d+14],17,-1502002290),h,c,a[d+15],22,1236535329),f=v(f,h=v(h,c=v(c,l,f,h,a[d+1],5,-165796510),l,f,a[d+6],9,-1069501632),c,l,a[d+11],14,643717713),h,c,a[d+0],20,-373897302),f=v(f,h=v(h,c=v(c,l,f,h,a[d+5],5,-701558691),l,f,a[d+10],9,38016083),c,l,a[d+15],14,-660478335),h,c,a[d+4],20,-405537848),f=v(f,h=v(h,c=v(c,l,f,h,a[d+9],5,568446438),l,f,a[d+14],9,-1019803690),c,l,a[d+3],14,-187363961),h,c,a[d+8],20,1163531501),f=v(f,h=v(h,c=v(c,l,f,h,a[d+13],5,-1444681467),l,f,a[d+2],9,-51403784),c,l,a[d+7],14,1735328473),h,c,a[d+12],20,-1926607734),f=y(f,h=y(h,c=y(c,l,f,h,a[d+5],4,-378558),l,f,a[d+8],11,-2022574463),c,l,a[d+11],16,1839030562),h,c,a[d+14],23,-35309556),f=y(f,h=y(h,c=y(c,l,f,h,a[d+1],4,-1530992060),l,f,a[d+4],11,1272893353),c,l,a[d+7],16,-155497632),h,c,a[d+10],23,-1094730640),f=y(f,h=y(h,c=y(c,l,f,h,a[d+13],4,681279174),l,f,a[d+0],11,-358537222),c,l,a[d+3],16,-722521979),h,c,a[d+6],23,76029189),f=y(f,h=y(h,c=y(c,l,f,h,a[d+9],4,-640364487),l,f,a[d+12],11,-421815835),c,l,a[d+15],16,530742520),h,c,a[d+2],23,-995338651),f=g(f,h=g(h,c=g(c,l,f,h,a[d+0],6,-198630844),l,f,a[d+7],10,1126891415),c,l,a[d+14],15,-1416354905),h,c,a[d+5],21,-57434055),f=g(f,h=g(h,c=g(c,l,f,h,a[d+12],6,1700485571),l,f,a[d+3],10,-1894986606),c,l,a[d+10],15,-1051523),h,c,a[d+1],21,-2054922799),f=g(f,h=g(h,c=g(c,l,f,h,a[d+8],6,1873313359),l,f,a[d+15],10,-30611744),c,l,a[d+6],15,-1560198380),h,c,a[d+13],21,1309151649),f=g(f,h=g(h,c=g(c,l,f,h,a[d+4],6,-145523070),l,f,a[d+11],10,-1120210379),c,l,a[d+2],15,718787259),h,c,a[d+9],21,-343485551),c=c+m>>>0,l=l+b>>>0,f=f+w>>>0,h=h+k>>>0}return r.endian([c,l,f,h])};i._ff=function(e,r,t,n,o,i,u){var a=e+(r&t|~r&n)+(o>>>0)+u;return(a<<i|a>>>32-i)+r},i._gg=function(e,r,t,n,o,i,u){var a=e+(r&n|t&~n)+(o>>>0)+u;return(a<<i|a>>>32-i)+r},i._hh=function(e,r,t,n,o,i,u){var a=e+(r^t^n)+(o>>>0)+u;return(a<<i|a>>>32-i)+r},i._ii=function(e,r,t,n,o,i,u){var a=e+(t^(r|~n))+(o>>>0)+u;return(a<<i|a>>>32-i)+r},i._blocksize=16,i._digestsize=16,e.exports=function(e,t){if(void 0===e||null===e)throw new Error("Illegal argument "+e);var n=r.wordsToBytes(i(e,t));return t&&t.asBytes?n:t&&t.asString?o.bytesToString(n):r.bytesToHex(n)}}()}),S={genSign:s,getHeaderSign:a,getPolicyAndAuthorization:c,getPurgeHeaderSign:l},P=function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")},j=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),C=function(){function e(e,r){var t=[],n=!0,o=!1,i=void 0;try{for(var u,a=e[Symbol.iterator]();!(n=(u=a.next()).done)&&(t.push(u.value),!r||t.length!==r);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(o)throw i}}return t}return function(r,t){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),T=function e(r){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";P(this,e),this.bucketName=r,this.serviceName=this.bucketName,this.operatorName=t,this.password=A(n)};return{Client:function(){function r(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;P(this,r);var o="undefined"!=typeof window;if(void 0===e.serviceName)throw new Error("upyun - must config serviceName");if("function"==typeof t&&(n=t,t={}),"function"!=typeof n&&o)throw new Error("upyun - must config a callback function getHeaderSign in client side");if(!o&&(void 0===e.operatorName||void 0===e.password))throw new Error("upyun - must config operateName and password in server side");this.isBrowser=o;var i=Object.assign({domain:"v0.api.upyun.com",protocol:"https"},t);this.endpoint=i.protocol+"://"+i.domain,this.req=d(this.endpoint,e,n||h),this.bucket=e,this.service=e,o||this.setBodySignCallback(S.getPolicyAndAuthorization)}return j(r,[{key:"setService",value:function(e){this.service=e,this.req.defaults.baseURL=this.endpoint+"/"+e.serviceName}},{key:"setBucket",value:function(e){return this.setService(e)}},{key:"setBodySignCallback",value:function(e){if("function"!=typeof e)throw new Error("upyun - getBodySign should be a function");this.bodySignCallback=e}},{key:"usage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/";return this.req.get(e+"?usage").then(function(e){var r=e.data;return Promise.resolve(r)})}},{key:"listDir",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/",r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=r.limit,n=void 0===t?100:t,o=r.order,i=void 0===o?"asc":o,u=r.iter,a=void 0===u?"":u,s={"x-list-limit":n,"x-list-order":i};return a&&(s["x-list-iter"]=a),this.req.get(e,{headers:s}).then(function(e){var r=e.data,t=e.headers;if(404===e.status)return!1;var n=t["x-upyun-list-iter"];if(!r)return Promise.resolve({files:[],next:n});var o=r.split("\n").map(function(e){var r=e.split("\t"),t=C(r,4),n=t[0],o=t[1],i=t[2],u=t[3];return{name:n,type:o,size:parseInt(i),time:parseInt(u)}});return Promise.resolve({files:o,next:n})})}},{key:"putFile",value:function(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n={};return["Content-MD5","Content-Length","Content-Type","Content-Secret","x-gmkerl-thumb"].forEach(function(e){var r=e.toLowerCase(),o=t[e]||t[r];o?n[e]=o:f(e)&&(n[e]=t[e])}),this.req.put(e,r,{headers:n}).then(function(e){var r=e.headers;if(200!==e.status)return Promise.resolve(!1);var t={};return["x-upyun-width","x-upyun-height","x-upyun-file-type","x-upyun-frames"].forEach(function(e){var n=e.split("x-upyun-")[1];r[e]&&(t[n]=r[e],"file-type"!==n&&(t[n]=parseInt(t[n],10)))}),Promise.resolve(!(Object.keys(t).length>0)||t)})}},{key:"makeDir",value:function(e){return this.req.post(e,null,{headers:{folder:"true"}}).then(function(e){var r=e.status;return Promise.resolve(200===r)})}},{key:"headFile",value:function(e){return this.req.head(e).then(function(e){var r=e.headers;if(404===e.status)return Promise.resolve(!1);var t={};return["x-upyun-file-type","x-upyun-file-size","x-upyun-file-date","Content-Md5"].forEach(function(e){var n=e.split("x-upyun-file-")[1];r[e]&&(t[n]=r[e],"size"!==n&&"date"!==n||(t[n]=parseInt(t[n],10)))}),Promise.resolve(t)})}},{key:"deleteFile",value:function(e){var r={};return arguments.length>1&&void 0!==arguments[1]&&arguments[1]&&(r["x-upyun-async"]=!0),this.req.delete(e,{headers:r}).then(function(e){var r=e.status;return Promise.resolve(200===r)})}},{key:"deleteDir",value:function(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return this.deleteFile.apply(this,r)}},{key:"getFile",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(r&&"undefined"!=typeof window)throw new Error("upyun - save as stream are only available on the server side.");return this.req({method:"GET",url:e,responseType:r?"stream":null}).then(function(e){if(404===e.status)return Promise.resolve(!1);if(!r)return Promise.resolve(e.data);var t=e.data.pipe(r);return new Promise(function(e,r){t.on("finish",function(){return e(t)}),t.on("error",r)})})}},{key:"updateMetadata",value:function(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"merge",n={};for(var o in r)f(o)?n[o]=r:n["x-upyun-meta-"+o]=r[o];return this.req.patch(e+"?metadata="+t,null,{headers:n}).then(function(e){var r=e.status;return Promise.resolve(200===r)})}},{key:"getMetadata",value:function(e){return this.req.get(e).then(function(e){var r=e.headers;if(200!==e.status)return Promise.resolve(!1);var t={};for(var n in r)f(n)&&(t[n]=r[n]);return Promise.resolve(t)})}},{key:"blockUpload",value:function(e,r){var t=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=void 0,i=void 0;return"undefined"!=typeof window?(o=Promise.resolve(r.size),i=r.type):(o=p.getFileSizeAsync(r),i=p.getContentType(r)),o.then(function(o){Object.assign(n,{"x-upyun-multi-stage":"initiate","x-upyun-multi-length":o,"x-upyun-multi-type":i});var u=Math.ceil(o/1048576);return t.req.put(e,null,{headers:n}).then(function(n){for(var i=n.headers,a=i["x-upyun-multi-uuid"],s=i["x-upyun-next-part-id"],c=Promise.resolve(s),l=0;l<u;l++)c=c.then(function(n){var i=1048576*n,u=Math.min(i+1048576,o);return p.readBlockAsync(r,i,u).then(function(r){return t.req.put(e,r,{headers:{"x-upyun-multi-stage":"upload","x-upyun-multi-uuid":a,"x-upyun-part-id":n}}).then(function(e){var r=e.headers;return n=r["x-upyun-next-part-id"],Promise.resolve(n)})})});return c.then(function(){return t.req.put(e,null,{headers:{"x-upyun-multi-stage":"complete","x-upyun-multi-uuid":a}}).then(function(e){var r=e.status;return Promise.resolve(204===r||201===r)})})})})}},{key:"formPutFile",value:function(e,r){var n=this,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("function"!=typeof this.bodySignCallback)throw new Error("upyun - must setBodySignCallback first!");o.service=this.service.serviceName,o["save-key"]=e;var i=this.bodySignCallback(this.service,o);return"function"!=typeof i.then&&(i=Promise.resolve(i)),i.then(function(e){return t(n.endpoint+"/"+o.service,r,e).then(function(e){return Promise.resolve(e)})})}},{key:"purge",value:function(r){"string"==typeof r&&(r=[r]);var t=S.getPurgeHeaderSign(this.service,r);return e.post("http://purge.upyun.com/purge/","purge="+r.join("\n"),{headers:t}).then(function(e){var r=e.data;if(0===Object.keys(r.invalid_domain_of_url).length)return!0;throw new Error("some url purge failed "+r.invalid_domain_of_url.join(" "))},function(e){throw new Error("upyun - request failed: "+e.message)})}}]),r}(),sign:S,Bucket:T,Service:T}});